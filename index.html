<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동 업데이트 데이터 현황 및 AI 예측</title>
    <!-- Chart.js 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* 기본 스타일 설정 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        h1 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 25px; }
        h2 { color: #343a40; margin-top: 30px; margin-bottom: 15px; }
        .chart-container { margin-bottom: 40px; }
        
        /* 테이블 스타일 */
        .data-table-wrapper { overflow-x: auto; }
        table { width: 100%; max-width: 1000px; border-collapse: separate; border-spacing: 0; border: 1px solid #ddd; font-size: 14px; min-width: 300px; border-radius: 8px; overflow: hidden; margin-top: 20px; }
        thead th { padding: 14px; background-color: #f1f1f1; border-right: 1px solid #ccc; text-align: left; color: #333; }
        tbody td { padding: 12px; border-top: 1px solid #eee; border-right: 1px solid #eee; text-align: right; background-color: white; color: #343a40; }
        tbody tr:last-child td { border-bottom: none; }
        
        /* 변화량 색상 */
        .plus { color: #dc3545; font-weight: 600; } 
        .minus { color: #007bff; font-weight: 600; } 
        .zero { color: #6c757d; font-weight: 600; } 
        
        .first-col { text-align: left !important; color: #343a40; font-weight: normal; }
        .value-col { font-weight: bold; color: #333; }
        .right-align { text-align: right !important; }
        
        /* AI 예측 스타일 */
        .ai-box { white-space: pre-wrap; color: #007bff; font-weight: bold; padding: 15px; border: 1px dashed #007bff; border-radius: 6px; background-color: #f0f8ff; line-height: 1.6; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>자동 업데이트 데이터 차트 및 분석</h1>
        <!-- 쉘 스크립트 치환 영역 -->
        <p>최종 업데이트 시간: <span id="update-time">2025-11-01 22:22:03 KST</span></p>
        <!-- /쉘 스크립트 치환 영역 -->

        <div class="chart-container">
            <h2>데이터 추이 차트</h2>
            <canvas id="myChart"></canvas>
        </div>

        <div style="margin-bottom: 20px;">
            <h2>AI 예측 결과</h2>
            <!-- 쉘 스크립트 치환 영역 -->
            <div class="ai-box">출시 5일차(11월 1일) 누적 매출 데이터는 일관된 상승 추이를 보이며, 이는 MMORPG 장르 특성을 고려할 때 건강한 초기 성장세를 나타냅니다. 게임은 런칭 후에도 지속적으로 매출을 창출하고 있으며, 현재까지의 데이터만으로도 유저들의 활발한 인게임 활동과 구매가 유지되고 있음을 알 수 있습니다. 금일(11월 1일) 하루 동안의 총 예상 매출 규모는 약 **$755,000**로 예측됩니다.<br><br>현재의 매출 성장 추이가 11월 한 달간 유지된다고 가정할 경우, 11월 총 예상 매출은 약 **$22,650,000**에 이를 것으로 전망됩니다.</div>
            <!-- /쉘 스크립트 치환 영역 -->
        </div>
        
        <h2>일별 요약 데이터</h2>
        <!-- JS에서 동적으로 테이블이 채워질 예정 -->
        <div id="daily-table-container" class="data-table-wrapper">
             <p style="text-align: center; color: #6c757d;">데이터를 처리 중입니다...</p>
        </div>

        <h2 style="margin-top: 40px;">시간별 상세 데이터 (최근 30개 항목)</h2>
        <!-- JS에서 동적으로 테이블이 채워질 예정 -->
        <div id="hourly-table-container" class="data-table-wrapper">
             <p style="text-align: center; color: #6c757d;">데이터를 처리 중입니다...</p>
        </div>
        
        <script>
            // 쉘 스크립트에서 치환된 JSON 데이터 문자열을 로드합니다.
            // 이 문자열은 쉘 스크립트 실행 시 실제 데이터로 치환됩니다.
            const chartDataString = '{    "raw_data_string": "2025-11-01 08:25:36 KST : 3,235,300
2025-11-01 10:02:47 KST : 3,280,000
2025-11-01 11:11:03 KST : 3,298,800
2025-11-01 14:30:00 KST : 3,388,600
2025-11-01 15:37:06 KST : 3,446,400
2025-11-01 16:56:10 KST : 3,475,700
2025-11-01 17:17:10 KST : 3,501,400
2025-11-01 18:27:55 KST : 3,545,100
2025-11-01 20:04:13 KST : 3,600,600
2025-11-01 20:10:32 KST : 3,600,600
2025-11-01 20:18:51 KST : 3,600,600
2025-11-01 20:22:54 KST : 3,600,600
2025-11-01 20:27:11 KST : 3,600,600
2025-11-01 20:31:29 KST : 3,600,600
2025-11-01 20:36:13 KST : 3,600,600
2025-11-01 20:45:21 KST : 3,600,600
2025-11-01 20:54:42 KST : 3,600,600
2025-11-01 21:01:23 KST : 3,626,900
2025-11-01 21:03:56 KST : 3,626,900
2025-11-01 21:07:20 KST : 3,626,900
2025-11-01 21:11:26 KST : 3,626,900
2025-11-01 21:18:52 KST : 3,626,900
2025-11-01 21:26:05 KST : 3,626,900
2025-11-01 21:29:30 KST : 3,626,900
2025-11-01 21:37:44 KST : 3,626,900
2025-11-01 21:48:40 KST : 3,626,900
2025-11-01 21:55:55 KST : 3,626,900
2025-11-01 22:06:47 KST : 3,673,900
2025-11-01 22:13:08 KST : 3,673,900
2025-11-01 22:22:03 KST : 3,673,900",    "labels": [],    "values": []}';
            
            // 데이터 포맷팅 유틸리티 (천 단위 쉼표)
            function formatNumber(num) {
                return num.toLocaleString('en-US');
            }

            // 모든 데이터를 파싱하고 데이터셋을 준비하는 메인 함수
            function processDataAndRender() {
                let dataSetRaw;
                try {
                    // 쉘 스크립트에서 주입된 JSON 문자열 파싱
                    dataSetRaw = JSON.parse(chartDataString);
                } catch (e) {
                    console.error("Error parsing chart data JSON:", e);
                    // 오류 메시지 표시 후 종료
                    document.getElementById('daily-table-container').innerHTML = "<p style='text-align: center; color: #dc3545;'>데이터 로드 오류: 원시 JSON 문자열을 파싱할 수 없습니다.</p>";
                    document.getElementById('hourly-table-container').innerHTML = "";
                    return;
                }

                const rawData = dataSetRaw.raw_data_string;
                if (!rawData) {
                    document.getElementById('daily-table-container').innerHTML = "<p style='text-align: center; color: #6c757d;'>데이터를 찾을 수 없습니다.</p>";
                    document.getElementById('hourly-table-container').innerHTML = "";
                    return;
                }

                // 1. 데이터 파싱
                const lines = rawData.split('\n').filter(line => line.trim() !== '');
                const allData = []; // { datetime: string, value: number, date: string, time: string }

                for (const line of lines) {
                    const parts = line.split(' : ');
                    if (parts.length === 2) {
                        const datetimeRaw = parts[0].trim();
                        const valueRaw = parts[1].trim().replace(/,/g, '');
                        const value = parseInt(valueRaw, 10);
                        
                        if (!isNaN(value)) {
                            // datetimeRaw: "2025-11-01 22:13:08 KST"
                            const datePart = datetimeRaw.substring(0, 10); // "YYYY-MM-DD"
                            const timePart = datetimeRaw.substring(11, 16); // "HH:MM"

                            allData.push({ 
                                datetime: datetimeRaw, 
                                value: value, 
                                date: datePart,
                                time: timePart
                            });
                        }
                    }
                }
                
                // 차트 데이터 (최근 30개 항목만 사용)
                const chartData = allData.slice(-30);
                
                // 2. 차트 렌더링
                renderChart(chartData);

                // 3. 테이블 렌더링
                renderHourlyTable(chartData);
                renderDailyTable(allData);
            }

            // ====================================================================
            // 차트 렌더링 함수
            // ====================================================================

            function renderChart(data) {
                const ctx = document.getElementById('myChart').getContext('2d');
                
                if (data.length === 0) {
                    ctx.font = "16px sans-serif";
                    ctx.textAlign = "center";
                    // 캔버스 중앙에 텍스트를 출력하기 위해 캔버스 크기를 설정
                    ctx.canvas.height = 300; 
                    ctx.fillText("차트 데이터를 불러올 수 없습니다.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                const labels = data.map(d => d.datetime);
                const values = data.map(d => d.value);

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        // 라벨에서 시간 부분(HH:MM)만 잘라서 표시
                        labels: data.map(d => d.time), 
                        datasets: [{
                            label: '매출 추정치 ($)',
                            data: values,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            tension: 0.3, 
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        layout: { padding: { top: 10 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatNumber(context.parsed.y) + ' 달러($)'; 
                                    },
                                    title: function(context) {
                                        // 전체 시간 레이블 사용
                                        if (context.length > 0) {
                                            return labels[context[0].dataIndex];
                                        }
                                        return '';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: '시간대' },
                                ticks: { maxRotation: 45, minRotation: 45 }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value) + ' $';
                                    }
                                },
                                title: { display: true, text: '매출 ($)' }
                            }
                        }
                    }
                });
            }

            // ====================================================================
            // 시간별 테이블 렌더링 함수
            // ====================================================================

            function renderHourlyTable(data) {
                let rows = '';
                // 최신 데이터가 위에 오도록 역순으로 순회
                for (let i = data.length - 1; i >= 0; i--) {
                    const current = data[i];
                    const previous = (i > 0) ? data[i - 1] : null;
                    
                    let change = '---';
                    let className = 'zero';

                    if (previous && current.value !== undefined && previous.value !== undefined) {
                        const diff = current.value - previous.value;
                        const formattedDiff = formatNumber(Math.abs(diff));
                        
                        if (diff > 0) {
                            change = `+${formattedDiff}`;
                            className = 'plus';
                        } else if (diff < 0) {
                            change = `-${formattedDiff}`;
                            className = 'minus';
                        } else {
                            change = '0';
                            className = 'zero';
                        }
                    }

                    rows += `
                        <tr>
                            <td class="first-col">${current.datetime}</td>
                            <td class="value-col right-align">${formatNumber(current.value)}</td>
                            <td class="${className} right-align">${change}</td>
                        </tr>
                    `;
                }

                const tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="header-col">시간</th>
                                <th class="header-col right-align">값</th>
                                <th class="header-col right-align">변화</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.trim() || "<tr><td colspan='3' style='text-align: center; color: #6c757d;'>데이터를 찾을 수 없습니다.</td></tr>"}
                        </tbody>
                    </table>
                `;
                document.getElementById('hourly-table-container').innerHTML = tableHTML;
            }

            // ====================================================================
            // 일별 테이블 렌더링 함수
            // ====================================================================

            function renderDailyTable(data) {
                // 일별 최종값(마지막 값)을 저장
                const dailyFinalValues = {}; // { 'YYYY-MM-DD': finalValue }
                for (const d of data) {
                    dailyFinalValues[d.date] = d.value;
                }

                const dates = Object.keys(dailyFinalValues).sort(); // 오름차순 정렬

                let rows = '';
                let previousValue = null;

                // 날짜 오름차순으로 순회하며 변화량 계산
                for (let i = 0; i < dates.length; i++) {
                    const date = dates[i];
                    const currentValue = dailyFinalValues[date];
                    
                    let change = '---';
                    let className = 'zero';

                    if (previousValue !== null && currentValue !== undefined) {
                        const diff = currentValue - previousValue;
                        const formattedDiff = formatNumber(Math.abs(diff));
                        
                        if (diff > 0) {
                            change = `+${formattedDiff}`;
                            className = 'plus';
                        } else if (diff < 0) {
                            change = `-${formattedDiff}`;
                            className = 'minus';
                        } else {
                            change = '0';
                            className = 'zero';
                        }
                    }

                    // 최신 날짜가 위로 오도록 역순으로 문자열 추가
                    rows = `
                        <tr>
                            <td class="first-col">${date}</td>
                            <td class="value-col right-align">${formatNumber(currentValue)}</td>
                            <td class="${className} right-align">${change}</td>
                        </tr>
                    ` + rows; 
                    
                    previousValue = currentValue;
                }

                if (dates.length === 0) {
                    document.getElementById('daily-table-container').innerHTML = "<p style='text-align: center; color: #6c757d;'>데이터를 찾을 수 없습니다.</p>";
                    return;
                }

                const tableHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="header-col">날짜</th>
                                <th class="header-col right-align">값</th>
                                <th class="header-col right-align">변화</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                `;
                document.getElementById('daily-table-container').innerHTML = tableHTML;
            }
            
            // 페이지 로드 시 데이터 처리 및 렌더링 시작
            processDataAndRender();
        </script>
    </div>
</body>
</html>


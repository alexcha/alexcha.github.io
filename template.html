<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자동 업데이트 데이터 현황 및 AI 예측</title>
    <!-- Chart.js 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* 기본 스타일 설정 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        h1 { color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 25px; }
        h2 { color: #343a40; margin-top: 30px; margin-bottom: 15px; }
        .chart-container { margin-bottom: 40px; }
        
        /* 테이블 스타일 */
        .data-table-wrapper { overflow-x: auto; }
        table { width: 100%; max-width: 1000px; border-collapse: separate; border-spacing: 0; border: 1px solid #ddd; font-size: 14px; min-width: 300px; border-radius: 8px; overflow: hidden; margin-top: 20px; }
        thead th { padding: 14px; background-color: #f1f1f1; border-right: 1px solid #ccc; text-align: left; color: #333; }
        tbody td { padding: 12px; border-top: 1px solid #eee; border-right: 1px solid #eee; text-align: right; background-color: white; color: #343a40; }
        tbody tr:last-child td { border-bottom: none; }
        
        /* 변화량 색상 */
        .plus { color: #dc3545; font-weight: 600; } 
        .minus { color: #007bff; font-weight: 600; } 
        .zero { color: #6c757d; font-weight: 600; } 
        
        .first-col { text-align: left !important; color: #343a40; font-weight: normal; }
        .value-col { font-weight: bold; color: #333; }
        .right-align { text-align: right !important; }
        
        /* AI 예측 스타일 */
        .ai-box { white-space: pre-wrap; color: #007bff; font-weight: bold; padding: 15px; border: 1px dashed #007bff; border-radius: 6px; background-color: #f0f8ff; line-height: 1.6; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>자동 업데이트 데이터 차트 및 분석</h1>
        <p>최종 업데이트 시간: <span id="update-time">__LAST_UPDATE_TIME__</span></p>

        <div class="chart-container">
            <h2>데이터 추이 차트 (최근 30개 항목)</h2>
            <canvas id="myChart"></canvas>
        </div>

        <div style="margin-bottom: 20px;">
            <h2>AI 예측 결과</h2>
            <div class="ai-box">__AI_PREDICTION__</div>
        </div>
        
        <h2>일별 요약 데이터</h2>
        <div id="daily-table-container" class="data-table-wrapper">
             __DAILY_TABLE_HTML__
        </div>

        <h2 style="margin-top: 40px;">시간별 상세 데이터 (최근 30개 항목)</h2>
        <div id="hourly-table-container" class="data-table-wrapper">
             __HOURLY_TABLE_HTML__
        </div>
        
        <script>
            // 쉘 스크립트에 의해 원시 데이터 문자열이 **직접** 삽입될 영역입니다.
            // **AWK에 의해 치환됩니다.**
            const RAW_DATA_CONTENT = `RAW_DATA_PLACEHOLDER_FOR_JS`;
            
            // 데이터 포맷팅 유틸리티 (천 단위 쉼표)
            function formatNumber(num) {
                if (typeof num !== 'number') return num; 
                return num.toLocaleString('en-US');
            }

            // 모든 데이터를 파싱하고 차트를 렌더링하는 메인 함수
            function processDataAndRender() {
                const rawData = RAW_DATA_CONTENT;

                // PLACEHOLDER가 그대로 남아 있다면 오류 메시지를 출력하고 종료
                if (rawData.includes("RAW_DATA_PLACEHOLDER_FOR_JS") || rawData.trim().length === 0) {
                    console.error("데이터 로드 실패: 쉘 스크립트가 PLACEHOLDER를 치환하지 못했습니다.");
                    
                    const errorMsg = "<p style='text-align: center; color: #dc3545; font-weight: bold;'>데이터 로드 오류: 스크립트 치환 실패. 쉘 스크립트를 확인하세요.</p>";
                    document.getElementById('daily-table-container').innerHTML = errorMsg;
                    document.getElementById('hourly-table-container').innerHTML = "";
                    
                    const ctx = document.getElementById('myChart').getContext('2d');
                    ctx.canvas.height = 300; 
                    ctx.font = "16px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillStyle = "#dc3545";
                    ctx.fillText("데이터 로드 실패: 스크립트 치환 오류", ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }
                
                // 1. 데이터 파싱
                const lines = rawData.split('\n').filter(line => line.trim() !== '');
                const allData = []; 

                for (const line of lines) {
                    const parts = line.split(' : ');
                    if (parts.length === 2) {
                        const datetimeRaw = parts[0].trim();
                        const valueRaw = parts[1].trim().replace(/,/g, ''); 
                        const value = parseInt(valueRaw, 10);
                        
                        if (!isNaN(value)) {
                            const datePart = datetimeRaw.substring(0, 10); 
                            const timePart = datetimeRaw.substring(11, 16); 

                            allData.push({ 
                                datetime: datetimeRaw, 
                                value: value, 
                                date: datePart,
                                time: timePart
                            });
                        }
                    } 
                }
                
                // 차트 데이터 (최근 30개 항목만 사용)
                const chartData = allData.slice(-30);
                
                // 2. 차트 렌더링 (이전 HTML 파일의 renderChart 함수 로직과 동일)
                renderChart(chartData);
            }

            // 차트 렌더링 함수
            function renderChart(data) {
                const ctx = document.getElementById('myChart').getContext('2d');
                
                if (data.length === 0) {
                    ctx.canvas.height = 300; 
                    ctx.font = "16px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillStyle = "#6c757d";
                    ctx.fillText("차트 데이터를 불러올 수 없습니다. 데이터가 부족합니다.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                const labels = data.map(d => d.datetime);
                const values = data.map(d => d.value);

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.time), 
                        datasets: [{
                            label: '매출 추정치 ($)',
                            data: values,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            tension: 0.3, 
                            borderWidth: 2,
                            pointRadius: 3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        layout: { padding: { top: 10 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) { return formatNumber(context.parsed.y) + ' 달러($)'; },
                                    title: function(context) { return context.length > 0 ? labels[context[0].dataIndex] : ''; }
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: '시간대' }, ticks: { maxRotation: 45, minRotation: 45 } },
                            y: {
                                beginAtZero: false,
                                ticks: { callback: function(value) { return formatNumber(value) + ' $'; } },
                                title: { display: true, text: '매출 ($)' }
                            }
                        }
                    }
                });
            }
            
            // 페이지 로드 시 데이터 처리 및 렌더링 시작
            processDataAndRender();
        </script>
    </div>
</body>
</html>

